# Comparing `tmp/odoo_addon_mrp_lot_number_propagation-15.0.0.2.0.2-py3-none-any.whl.zip` & `tmp/odoo_addon_mrp_lot_number_propagation-15.0.0.3.0-py3-none-any.whl.zip`

## zipinfo {}

```diff
@@ -1,29 +1,29 @@
-Zip file size: 35621 bytes, number of entries: 27
--rw-r--r--  2.0 unx     3392 b- defN 23-Mar-23 05:41 odoo/addons/mrp_lot_number_propagation/README.rst
--rw-r--r--  2.0 unx       21 b- defN 23-Mar-23 05:41 odoo/addons/mrp_lot_number_propagation/__init__.py
--rw-r--r--  2.0 unx      656 b- defN 23-Mar-23 05:41 odoo/addons/mrp_lot_number_propagation/__manifest__.py
--rw-r--r--  2.0 unx     7290 b- defN 23-Mar-23 05:41 odoo/addons/mrp_lot_number_propagation/i18n/it.po
--rw-r--r--  2.0 unx     5295 b- defN 23-Mar-23 05:41 odoo/addons/mrp_lot_number_propagation/i18n/mrp_lot_number_propagation.pot
--rw-r--r--  2.0 unx      164 b- defN 23-Mar-23 05:41 odoo/addons/mrp_lot_number_propagation/models/__init__.py
--rw-r--r--  2.0 unx     3240 b- defN 23-Mar-23 05:41 odoo/addons/mrp_lot_number_propagation/models/mrp_bom.py
--rw-r--r--  2.0 unx     1666 b- defN 23-Mar-23 05:41 odoo/addons/mrp_lot_number_propagation/models/mrp_bom_line.py
--rw-r--r--  2.0 unx     6910 b- defN 23-Mar-23 05:41 odoo/addons/mrp_lot_number_propagation/models/mrp_production.py
--rw-r--r--  2.0 unx      374 b- defN 23-Mar-23 05:41 odoo/addons/mrp_lot_number_propagation/models/product_product.py
--rw-r--r--  2.0 unx     1621 b- defN 23-Mar-23 05:41 odoo/addons/mrp_lot_number_propagation/models/product_template.py
--rw-r--r--  2.0 unx      284 b- defN 23-Mar-23 05:41 odoo/addons/mrp_lot_number_propagation/models/stock_move.py
--rw-r--r--  2.0 unx       99 b- defN 23-Mar-23 05:41 odoo/addons/mrp_lot_number_propagation/readme/CONTRIBUTORS.rst
--rw-r--r--  2.0 unx       72 b- defN 23-Mar-23 05:41 odoo/addons/mrp_lot_number_propagation/readme/DESCRIPTION.rst
--rw-r--r--  2.0 unx       67 b- defN 23-Mar-23 05:41 odoo/addons/mrp_lot_number_propagation/readme/ROADMAP.rst
--rw-r--r--  2.0 unx     9455 b- defN 23-Mar-23 05:41 odoo/addons/mrp_lot_number_propagation/static/description/icon.png
--rw-r--r--  2.0 unx    12976 b- defN 23-Mar-23 05:41 odoo/addons/mrp_lot_number_propagation/static/description/index.html
--rw-r--r--  2.0 unx       27 b- defN 23-Mar-23 05:41 odoo/addons/mrp_lot_number_propagation/tests/__init__.py
--rw-r--r--  2.0 unx     6377 b- defN 23-Mar-23 05:41 odoo/addons/mrp_lot_number_propagation/tests/common.py
--rw-r--r--  2.0 unx     3085 b- defN 23-Mar-23 05:41 odoo/addons/mrp_lot_number_propagation/tests/test_mrp_bom.py
--rw-r--r--  2.0 unx     4482 b- defN 23-Mar-23 05:41 odoo/addons/mrp_lot_number_propagation/tests/test_mrp_production.py
--rw-r--r--  2.0 unx     1134 b- defN 23-Mar-23 05:41 odoo/addons/mrp_lot_number_propagation/views/mrp_bom.xml
--rw-r--r--  2.0 unx      969 b- defN 23-Mar-23 05:41 odoo/addons/mrp_lot_number_propagation/views/mrp_production.xml
--rw-r--r--  2.0 unx     4024 b- defN 23-Mar-23 05:41 odoo_addon_mrp_lot_number_propagation-15.0.0.2.0.2.dist-info/METADATA
--rw-r--r--  2.0 unx       92 b- defN 23-Mar-23 05:41 odoo_addon_mrp_lot_number_propagation-15.0.0.2.0.2.dist-info/WHEEL
--rw-r--r--  2.0 unx        5 b- defN 23-Mar-23 05:41 odoo_addon_mrp_lot_number_propagation-15.0.0.2.0.2.dist-info/top_level.txt
-?rw-rw-r--  2.0 unx     3113 b- defN 23-Mar-23 05:41 odoo_addon_mrp_lot_number_propagation-15.0.0.2.0.2.dist-info/RECORD
-27 files, 76890 bytes uncompressed, 30253 bytes compressed:  60.7%
+Zip file size: 36068 bytes, number of entries: 27
+-rw-r--r--  2.0 unx     3392 b- defN 23-Apr-21 07:45 odoo/addons/mrp_lot_number_propagation/README.rst
+-rw-r--r--  2.0 unx       21 b- defN 23-Apr-21 07:45 odoo/addons/mrp_lot_number_propagation/__init__.py
+-rw-r--r--  2.0 unx      656 b- defN 23-Apr-21 07:45 odoo/addons/mrp_lot_number_propagation/__manifest__.py
+-rw-r--r--  2.0 unx     7290 b- defN 23-Apr-21 07:45 odoo/addons/mrp_lot_number_propagation/i18n/it.po
+-rw-r--r--  2.0 unx     5523 b- defN 23-Apr-21 07:45 odoo/addons/mrp_lot_number_propagation/i18n/mrp_lot_number_propagation.pot
+-rw-r--r--  2.0 unx      164 b- defN 23-Apr-21 07:45 odoo/addons/mrp_lot_number_propagation/models/__init__.py
+-rw-r--r--  2.0 unx     3240 b- defN 23-Apr-21 07:45 odoo/addons/mrp_lot_number_propagation/models/mrp_bom.py
+-rw-r--r--  2.0 unx     1666 b- defN 23-Apr-21 07:45 odoo/addons/mrp_lot_number_propagation/models/mrp_bom_line.py
+-rw-r--r--  2.0 unx     7648 b- defN 23-Apr-21 07:45 odoo/addons/mrp_lot_number_propagation/models/mrp_production.py
+-rw-r--r--  2.0 unx      374 b- defN 23-Apr-21 07:45 odoo/addons/mrp_lot_number_propagation/models/product_product.py
+-rw-r--r--  2.0 unx     1621 b- defN 23-Apr-21 07:45 odoo/addons/mrp_lot_number_propagation/models/product_template.py
+-rw-r--r--  2.0 unx      284 b- defN 23-Apr-21 07:45 odoo/addons/mrp_lot_number_propagation/models/stock_move.py
+-rw-r--r--  2.0 unx       99 b- defN 23-Apr-21 07:45 odoo/addons/mrp_lot_number_propagation/readme/CONTRIBUTORS.rst
+-rw-r--r--  2.0 unx       72 b- defN 23-Apr-21 07:45 odoo/addons/mrp_lot_number_propagation/readme/DESCRIPTION.rst
+-rw-r--r--  2.0 unx       67 b- defN 23-Apr-21 07:45 odoo/addons/mrp_lot_number_propagation/readme/ROADMAP.rst
+-rw-r--r--  2.0 unx     9455 b- defN 23-Apr-21 07:45 odoo/addons/mrp_lot_number_propagation/static/description/icon.png
+-rw-r--r--  2.0 unx    12976 b- defN 23-Apr-21 07:45 odoo/addons/mrp_lot_number_propagation/static/description/index.html
+-rw-r--r--  2.0 unx       27 b- defN 23-Apr-21 07:45 odoo/addons/mrp_lot_number_propagation/tests/__init__.py
+-rw-r--r--  2.0 unx     6377 b- defN 23-Apr-21 07:45 odoo/addons/mrp_lot_number_propagation/tests/common.py
+-rw-r--r--  2.0 unx     3085 b- defN 23-Apr-21 07:45 odoo/addons/mrp_lot_number_propagation/tests/test_mrp_bom.py
+-rw-r--r--  2.0 unx     6319 b- defN 23-Apr-21 07:45 odoo/addons/mrp_lot_number_propagation/tests/test_mrp_production.py
+-rw-r--r--  2.0 unx     1134 b- defN 23-Apr-21 07:45 odoo/addons/mrp_lot_number_propagation/views/mrp_bom.xml
+-rw-r--r--  2.0 unx      969 b- defN 23-Apr-21 07:45 odoo/addons/mrp_lot_number_propagation/views/mrp_production.xml
+-rw-r--r--  2.0 unx     4022 b- defN 23-Apr-21 07:45 odoo_addon_mrp_lot_number_propagation-15.0.0.3.0.dist-info/METADATA
+-rw-r--r--  2.0 unx       92 b- defN 23-Apr-21 07:45 odoo_addon_mrp_lot_number_propagation-15.0.0.3.0.dist-info/WHEEL
+-rw-r--r--  2.0 unx        5 b- defN 23-Apr-21 07:45 odoo_addon_mrp_lot_number_propagation-15.0.0.3.0.dist-info/top_level.txt
+?rw-rw-r--  2.0 unx     3105 b- defN 23-Apr-21 07:45 odoo_addon_mrp_lot_number_propagation-15.0.0.3.0.dist-info/RECORD
+27 files, 79683 bytes uncompressed, 30716 bytes compressed:  61.5%
```

## zipnote {}

```diff
@@ -63,20 +63,20 @@
 
 Filename: odoo/addons/mrp_lot_number_propagation/views/mrp_bom.xml
 Comment: 
 
 Filename: odoo/addons/mrp_lot_number_propagation/views/mrp_production.xml
 Comment: 
 
-Filename: odoo_addon_mrp_lot_number_propagation-15.0.0.2.0.2.dist-info/METADATA
+Filename: odoo_addon_mrp_lot_number_propagation-15.0.0.3.0.dist-info/METADATA
 Comment: 
 
-Filename: odoo_addon_mrp_lot_number_propagation-15.0.0.2.0.2.dist-info/WHEEL
+Filename: odoo_addon_mrp_lot_number_propagation-15.0.0.3.0.dist-info/WHEEL
 Comment: 
 
-Filename: odoo_addon_mrp_lot_number_propagation-15.0.0.2.0.2.dist-info/top_level.txt
+Filename: odoo_addon_mrp_lot_number_propagation-15.0.0.3.0.dist-info/top_level.txt
 Comment: 
 
-Filename: odoo_addon_mrp_lot_number_propagation-15.0.0.2.0.2.dist-info/RECORD
+Filename: odoo_addon_mrp_lot_number_propagation-15.0.0.3.0.dist-info/RECORD
 Comment: 
 
 Zip file comment:
```

## odoo/addons/mrp_lot_number_propagation/__manifest__.py

```diff
@@ -1,12 +1,12 @@
 # Copyright 2022 Camptocamp SA
 # License AGPL-3.0 or later (http://www.gnu.org/licenses/agpl)
 {
     "name": "MRP Serial Number Propagation",
-    "version": "15.0.0.2.0",
+    "version": "15.0.0.3.0",
     "development_status": "Alpha",
     "license": "AGPL-3",
     "author": "Camptocamp, Odoo Community Association (OCA)",
     "maintainers": ["sebalix"],
     "summary": "Propagate a serial number from a component to a finished product",
     "website": "https://github.com/OCA/manufacture",
     "category": "Manufacturing",
```

## odoo/addons/mrp_lot_number_propagation/i18n/mrp_lot_number_propagation.pot

```diff
@@ -79,14 +79,22 @@
 msgid "Lot/Serial Number"
 msgstr ""
 
 #. module: mrp_lot_number_propagation
 #: code:addons/mrp_lot_number_propagation/models/mrp_production.py:0
 #, python-format
 msgid ""
+"Lot/Serial number %s already exists and has been used. Unable to propagate "
+"it."
+msgstr ""
+
+#. module: mrp_lot_number_propagation
+#: code:addons/mrp_lot_number_propagation/models/mrp_production.py:0
+#, python-format
+msgid ""
 "Lot/Serial number is propagated from a component, you are not allowed to "
 "change it."
 msgstr ""
 
 #. module: mrp_lot_number_propagation
 #: model:ir.model.fields,help:mrp_lot_number_propagation.field_mrp_production__is_lot_number_propagated
 msgid ""
```

## odoo/addons/mrp_lot_number_propagation/models/mrp_production.py

```diff
@@ -107,21 +107,38 @@
             if not order.is_lot_number_propagated or order.lot_producing_id:
                 continue
             finish_moves = order.move_finished_ids.filtered(
                 lambda m: m.product_id == order.product_id
                 and m.state not in ("done", "cancel")
             )
             if finish_moves and not finish_moves.quantity_done:
-                lot = self.env["stock.production.lot"].create(
-                    {
-                        "product_id": order.product_id.id,
-                        "company_id": order.company_id.id,
-                        "name": order.propagated_lot_producing,
-                    }
+                lot_model = self.env["stock.production.lot"]
+                lot = lot_model.search(
+                    [
+                        ("product_id", "=", order.product_id.id),
+                        ("company_id", "=", order.company_id.id),
+                        ("name", "=", order.propagated_lot_producing),
+                    ],
+                    limit=1,
                 )
+                if lot.quant_ids:
+                    raise UserError(
+                        _(
+                            "Lot/Serial number %s already exists and has been used. "
+                            "Unable to propagate it."
+                        )
+                    )
+                if not lot:
+                    lot = self.env["stock.production.lot"].create(
+                        {
+                            "product_id": order.product_id.id,
+                            "company_id": order.company_id.id,
+                            "name": order.propagated_lot_producing,
+                        }
+                    )
                 order.with_context(lot_propagation=True).lot_producing_id = lot
 
     def write(self, vals):
         for order in self:
             if (
                 order.is_lot_number_propagated
                 and "lot_producing_id" in vals
```

## odoo/addons/mrp_lot_number_propagation/tests/test_mrp_production.py

```diff
@@ -53,14 +53,55 @@
     def test_order_post_inventory(self):
         self._update_stock_component_qty(self.order)
         self.order.action_confirm()
         self._set_qty_done(self.order)
         self.order.button_mark_done()
         self.assertEqual(self.order.lot_producing_id.name, self.LOT_NAME)
 
+    def test_order_post_inventory_lot_already_exists_but_not_used(self):
+        self._update_stock_component_qty(self.order)
+        self.order.action_confirm()
+        self._set_qty_done(self.order)
+        self.assertEqual(self.order.propagated_lot_producing, self.LOT_NAME)
+        # Create a lot with the same number for the finished product
+        # without any stock/quants (so not used at all) before validating the MO
+        existing_lot = self.env["stock.production.lot"].create(
+            {
+                "product_id": self.order.product_id.id,
+                "company_id": self.order.company_id.id,
+                "name": self.order.propagated_lot_producing,
+            }
+        )
+        self.order.button_mark_done()
+        self.assertEqual(self.order.lot_producing_id, existing_lot)
+
+    def test_order_post_inventory_lot_already_exists_and_used(self):
+        self._update_stock_component_qty(self.order)
+        self.order.action_confirm()
+        self._set_qty_done(self.order)
+        self.assertEqual(self.order.propagated_lot_producing, self.LOT_NAME)
+        # Create a lot with the same number for the finished product
+        # with some stock/quants (so it is considered as used) before
+        # validating the MO
+        existing_lot = self.env["stock.production.lot"].create(
+            {
+                "product_id": self.order.product_id.id,
+                "company_id": self.order.company_id.id,
+                "name": self.order.propagated_lot_producing,
+            }
+        )
+        self._update_qty_in_location(
+            self.env.ref("stock.stock_location_stock"),
+            self.order.product_id,
+            1,
+            lot=existing_lot,
+        )
+        with self.assertRaisesRegex(UserError, "already exists and has been used"):
+            self.order.button_mark_done()
+
     def test_confirm_with_variant_ok(self):
         self._add_color_and_legs_variants(self.bom_product_template)
         self._add_color_and_legs_variants(self.product_template_tracked_by_sn)
         new_bom = self._create_bom_with_variants()
         self.assertTrue(new_bom.lot_number_propagation)
         # As all variants must have a single component
         #  where lot must be propagated, there should not be any error
```

## Comparing `odoo_addon_mrp_lot_number_propagation-15.0.0.2.0.2.dist-info/METADATA` & `odoo_addon_mrp_lot_number_propagation-15.0.0.3.0.dist-info/METADATA`

 * *Files 1% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: odoo-addon-mrp-lot-number-propagation
-Version: 15.0.0.2.0.2
+Version: 15.0.0.3.0
 Summary: Propagate a serial number from a component to a finished product
 Home-page: https://github.com/OCA/manufacture
 Author: Camptocamp, Odoo Community Association (OCA)
 Author-email: support@odoo-community.org
 License: AGPL-3
 Platform: UNKNOWN
 Classifier: Programming Language :: Python
```

## Comparing `odoo_addon_mrp_lot_number_propagation-15.0.0.2.0.2.dist-info/RECORD` & `odoo_addon_mrp_lot_number_propagation-15.0.0.3.0.dist-info/RECORD`

 * *Files 8% similar despite different names*

```diff
@@ -1,27 +1,27 @@
 odoo/addons/mrp_lot_number_propagation/README.rst,sha256=gLyMylbU_2WzsrcrQjIl3E9aqNS42RqMdqAisxsgiPU,3392
 odoo/addons/mrp_lot_number_propagation/__init__.py,sha256=X9EJGOE2GtZbS0G82PtSXmWSZ_R8jEM0rlJTDliQjp4,21
-odoo/addons/mrp_lot_number_propagation/__manifest__.py,sha256=WmH3XJFHpirEfu9fzXmt8weiCuBc4OnRuquwfkQiZVQ,656
+odoo/addons/mrp_lot_number_propagation/__manifest__.py,sha256=D0MkXWf0CFQuvv48JEW4xubFTSDJssriqCVJBoY94xc,656
 odoo/addons/mrp_lot_number_propagation/i18n/it.po,sha256=ogoSMFuK9wu_kTa9jbsBwiaPu2NJjVZWBqyMsHy9VHE,7290
-odoo/addons/mrp_lot_number_propagation/i18n/mrp_lot_number_propagation.pot,sha256=R6Y1nF_-as1ioLWPPtQhksq4JYOO6ZB8hGj6DCBrMSU,5295
+odoo/addons/mrp_lot_number_propagation/i18n/mrp_lot_number_propagation.pot,sha256=JGAmFc2okP0w4sk6y86Na2prPnYtzctQ70-I6bpaXVk,5523
 odoo/addons/mrp_lot_number_propagation/models/__init__.py,sha256=vrTSOK-o8GQIO5ZhYRn0G5VGlhDhWe97Z4ExuEujjIE,164
 odoo/addons/mrp_lot_number_propagation/models/mrp_bom.py,sha256=9mIHMJUrKK0RcY4MNOAcxBaK8WcovcerPQ0xvrD_R0Y,3240
 odoo/addons/mrp_lot_number_propagation/models/mrp_bom_line.py,sha256=KxiYEsxUGiVZc1W2TfEmcEar95lHKwxQNI7CZvGuCOk,1666
-odoo/addons/mrp_lot_number_propagation/models/mrp_production.py,sha256=6DZKxJrWYM95m-57N68GY8_VidCkASjChqqh1HMSARw,6910
+odoo/addons/mrp_lot_number_propagation/models/mrp_production.py,sha256=Dpcwy-QENQwyziqwXUFYLLGrA0allVCdAPK7U6OlOVI,7648
 odoo/addons/mrp_lot_number_propagation/models/product_product.py,sha256=ClNjcBfdwQ9m2PY-2J2IxUyoQ3X7n3bDQciBetERjiA,374
 odoo/addons/mrp_lot_number_propagation/models/product_template.py,sha256=EN64C7RqnQQS_MwnPzIihJZrhNvyvJqx8qp5Ip1AQJg,1621
 odoo/addons/mrp_lot_number_propagation/models/stock_move.py,sha256=-SxfzdDmEyKGbdvX-vriR6-KIbd6sDTcj4PN2O7ssFc,284
 odoo/addons/mrp_lot_number_propagation/readme/CONTRIBUTORS.rst,sha256=9S6IU7QJrCd_erf1j9F6MPPXuQffG9oMEUQa4hE8D1o,99
 odoo/addons/mrp_lot_number_propagation/readme/DESCRIPTION.rst,sha256=ig8ZY4RUrM_JxKYmz8fVg8J1SAD6iwsSy5OTwjil-2w,72
 odoo/addons/mrp_lot_number_propagation/readme/ROADMAP.rst,sha256=02g5-cpbuBx90VbEqaMP99kKOHjEYsAYQs3dZhc9o3Y,67
 odoo/addons/mrp_lot_number_propagation/static/description/icon.png,sha256=6xBPJauaFOF0KDHfHgQopSc28kKvxMaeoQFQWZtfZDo,9455
 odoo/addons/mrp_lot_number_propagation/static/description/index.html,sha256=PE-VUVxYw9yZbcgcb_nFuRq7SRxJcT7sNM-w5PEbeZA,12976
 odoo/addons/mrp_lot_number_propagation/tests/__init__.py,sha256=wl5DAY2sm9vpfFO8aY53k6tgqwBgPmSrsWXRNupCcM4,27
 odoo/addons/mrp_lot_number_propagation/tests/common.py,sha256=dDmeHHqxeGFhXh83AYbOsrpvVg9YKYugFPL0_d_xhD0,6377
 odoo/addons/mrp_lot_number_propagation/tests/test_mrp_bom.py,sha256=A8P--rWtRy9UrtbBBqBNjpFOaxOt9zqubroIJbGClnE,3085
-odoo/addons/mrp_lot_number_propagation/tests/test_mrp_production.py,sha256=nm3oXHhr4GhxR6dL0aTaM1PRXedlh0NMvMQnPrUKF2w,4482
+odoo/addons/mrp_lot_number_propagation/tests/test_mrp_production.py,sha256=kryjW2BSd4n5r-DT-X43doD23Dw0c0gNBZDwFHNbrNA,6319
 odoo/addons/mrp_lot_number_propagation/views/mrp_bom.xml,sha256=QbnBy_fgH8zPQ2Dwm5gnQ9Ho50m4L4qgag3zj4Brmxw,1134
 odoo/addons/mrp_lot_number_propagation/views/mrp_production.xml,sha256=qoUN93iz6hnJVVWGfBVEBH2iQvoQZMTRZQ-TPyKPNbQ,969
-odoo_addon_mrp_lot_number_propagation-15.0.0.2.0.2.dist-info/METADATA,sha256=j2rCd3gAVX10U18W5RwbcCdg76-z8dDWlNMuiXeYaQA,4024
-odoo_addon_mrp_lot_number_propagation-15.0.0.2.0.2.dist-info/WHEEL,sha256=2wepM1nk4DS4eFpYrW1TTqPcoGNfHhhO_i5m4cOimbo,92
-odoo_addon_mrp_lot_number_propagation-15.0.0.2.0.2.dist-info/top_level.txt,sha256=qBj40grFkGOfDZ2WDSw3y1RnDlgG0u8rP8pvGNdbz4w,5
-odoo_addon_mrp_lot_number_propagation-15.0.0.2.0.2.dist-info/RECORD,,
+odoo_addon_mrp_lot_number_propagation-15.0.0.3.0.dist-info/METADATA,sha256=QL3_jseZgXoXrfmMYOuueYC8mODanUqVXSibE6ROKF4,4022
+odoo_addon_mrp_lot_number_propagation-15.0.0.3.0.dist-info/WHEEL,sha256=2wepM1nk4DS4eFpYrW1TTqPcoGNfHhhO_i5m4cOimbo,92
+odoo_addon_mrp_lot_number_propagation-15.0.0.3.0.dist-info/top_level.txt,sha256=qBj40grFkGOfDZ2WDSw3y1RnDlgG0u8rP8pvGNdbz4w,5
+odoo_addon_mrp_lot_number_propagation-15.0.0.3.0.dist-info/RECORD,,
```

